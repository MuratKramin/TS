# Проект по временным рядам 
# Выполнил: Крамин Мурат Тимурович, ФТиАД, 1 курс


# **ПЛАН ПРОЕКТА** (Содержание)

- [Блок 0. Подготовка данных](#0)
- [Блок 1. Генерация признаков для ML](#1)
- [Блок 2. Анализ временного ряда `balance` (для ARIMA/SARIMA)](#2)
- [Блок 3. Построение авторегрессионных моделей](#3)
- [Блок 4. `tsfresh` как обогащение признаков](#4)
- [Блок 5. Отбор признаков (FS) для ML](#5)
- [Блок 6. Построение ML моделей](#6)
- [Блок 7. Обнаружение разладок (CUSUM)](#7)
- [Блок 8. Онлайн и Автоматическое переобучение](#8)
- [Итоговый вывод по проекту](#9)


## Блок 0. Подготовка данных <a class="anchor" id="0"></a>


### Извелекаем данные из exel файла

### Парсим и сохраняем нерабочие дни из производственного календаря

### Парсим и сохраняем ключевую ставку с сайта ЦБ

### Парсим и сохраняем курс рубля к доллару

### Скачиваем с сайта (https://investfunds.ru/indexes/224/) 
### и сохраняем курс золота (Банк России)

### Парсим и сохраняем курс нефти Brent

### Парсим и сохраняем АРХИВ ЗНАЧЕНИЙ MOSPRIME

### Используя нерабочие дни и другие календарные фичи создаём расширенный датасет календарных фич

## Почему были добавлены календарные признаки

Календарные фичи отражают структуру времени и специфику финансовых процессов, зависящих от даты. Их добавление позволяет учесть влияние календарных факторов на динамику ликвидности:

* **Нерабочие дни**, **праздничные дни** и **пред/после праздников** — влияют на активность клиентов и операции Банка.
* **День недели, месяц, начало/конец месяца** — захватывают периодичность операций (например, списания в конце месяца).
* **Налоговые даты** — отражают точки возможных крупных платежей, особенно по НДС, прибыли и другим налогам.
* **Особые дни декабря** — связаны с планированием на конец года, что может сильно влиять на поведение сальдо.
* **Годовые признаки** — позволяют модели учитывать возможные годовые тренды и эффекты.


### Объединяем все полученные данные в один датасет

# Блок 1. Генерация признаков для ML <a class="anchor" id="1"></a>

### Добавим в объединённый датасет лаги и скользящие различного рода

## Почему были добавленны данные фичи обоснование:

Добавление лагов и скользящих статистик (rolling mean, std, min, max, median) позволяет модели захватывать динамику временного ряда и учитывать временные зависимости:

* **Лаги (`_lag`)** отражают значения признаков в прошлые дни и помогают уловить авторегрессионные закономерности (например, влияние баланса вчера на сегодняшний день).
* **Скользящие средние и статистики (`_rollmean`, `_rollstd`, `_rollmin`, `_rollmax`, `_rollmed`)** обобщают поведение ряда за последние дни, сглаживают шум и помогают учитывать локальные тренды и волатильность.
* **Shift(1)** используется, чтобы не допустить утечки информации из будущего в момент прогнозирования.

Эти признаки усиливают модель за счёт учёта краткосрочной истории и устойчивых паттернов.


# **Блок 1.2. Построение метрик для оценок моделей**  <a class="anchor" id="1.2"></a>

## Обоснование выбора метрик:
### Что считают мои метрики и зачем они нужны бизнесу:


**1. `calculate_add_margin_vectorized`**
- **Что считает:** Среднюю дополнительную прибыль, которую можно было бы заработать, если бы использовать прогноз вместо базовой стратегии размещения средств (размещения остатка в ЦБ под ставку ниже рыночной).
- **Экономический смысл:** Эта метрика напрямую отвечает на вопрос заказчика: сколько денег в среднем можно дополнительно заработать за день благодаря использованию модели. Она учитывает не только доход от правильных прогнозов, но и штраф за излишний оптимизм (если спрогнозировали слишком большой приток, а в реальности пришло меньше).

**2. `normalized_add_margin`**
- **Что считает:** Относительную дополнительную маржу (в процентах от референсного объёма баланса).
- **Экономический смысл:** Иногда абсолютная дополнительная прибыль может быть не слишком наглядной. Нормализация позволяет понять эффективность модели относительно типичных объёмов — например, зарабатываем мы +0.2% или +1% от среднего объёма. Это важно для оценки масштаба влияния модели на бизнес в процентах, а не в абсолютных рублях.

**3. `calculate_total_add_margin`**
- **Что считает:** Полную сумму дополнительной маржи за весь период расчёта.
- **Экономический смысл:** Бизнес смотрит не только на средние цифры, но и на итоговую сумму заработка за месяц, квартал, год. Эта метрика позволяет сразу понять: принесла ли модель ощутимую выгоду или осталась "в нулях" после учёта всех корректировок и штрафов.

**4. `awmae` (Asymmetric Weighted MAE)**
- **Что считает:** Среднюю абсолютную ошибку, но с разным весом для ошибок в сторону дефицита и профицита.
- **Экономический смысл:** Ошибки в разные стороны стоят бизнесу по-разному: дефицит ликвидности дороже профицита, потому что займ под ключ+1% дороже потерь доходности при размещении профицита. Поэтому в `awmae` штраф за дефицит больше, чем за лишние деньги на счетах. Такая метрика лучше соответствует реальным потерям банка.

**5. `delta_pnl`**
- **Что считает:** Среднюю разницу между реальным результатом операций при использовании прогноза и идеальным вариантом (если бы мы заранее знали фактические потоки).
- **Экономический смысл:** Это модельная оценка: насколько близко модель позволяет приблизиться к максимальной возможной прибыли. Иначе говоря, сколько прибыли теряется из-за ошибок модели — с учётом реальных процентных ставок по размещению, заимствованию и альтернативным операциям.

# **Блок 2. Анализ временного ряда `balance`**  <a class="anchor" id="2"></a>


## Выводы по итогам анализа ряда

## 1. Общая характеристика
- Ряд содержит **1543 наблюдения**, пропусков нет.
- Среднее значение около нуля (**-0.048**), медиана тоже **0.0** — тренд в целом отсутствует.
- Диапазон значений достаточно широкий: от **-2.51** до **1.41**, при этом стандартное отклонение небольшое (**0.29**), что говорит о средней волатильности.
- Распределение немного скошено в сторону отрицательных значений.

## 2. Наличие сезонности и тренда
- Декомпозиция показала, что:
  - Тренд минимальный (**-0.05**),
  - Сезонная компонента стабильная (**стандартное отклонение 0.08**),
  - Остатки более шумные (**стандартное отклонение 0.25**).
- Это указывает на то, что в ряде есть **неделяная сезонность**, но она выражена умеренно. Основные колебания объясняются случайными факторами.

## 3. Стационарность
- По результатам ADF-теста можно считать, что ряд стационарный.
- KPSS-тест, напротив, говорит о наличии нестабильности.
- Такое расхождение между тестами обычно возникает в случаях слабого тренда или сезонности. Это подтверждается наблюдаемой недельной структурой в данных.

После применения обычной разности (`diff(1)`) и сезонной разности (`diff(7)`):
- ADF и KPSS уверенно подтверждают стационарность ряда.
- Следовательно, для моделирования требуется как минимум одна обычная и одна сезонная разности.

## 4. ACF и PACF
- В ACF на исходном ряде видны выраженные пики на лагах кратных 7 (7, 14, 21, 28, 35) — характерный признак недельной сезонности.
- PACF показывает заметные частичные корреляции на лагах 1 и 7.
- На дифференцированных рядах недельный эффект сохраняется.


# Почему выбрана SARIMA/SARIMAX

### Почему не ARIMAX
- Модель ARIMA была отвергнута из-за игнорирования сезонной структуры ряда, подтверждённой аналитикой.

### Выбор в пользу SARIMA
- Модель SARIMA хорошо подходит для рядов с сезонностью и необходимостью дифференцирования.
- В нашем случае наблюдается четкая недельная сезонность, а стационарности удается добиться только после применения разностей.
- Поэтому SARIMA — естественный выбор для базового моделирования.

### Почему SARIMAX
- SARIMAX расширяет возможности модели, позволяя добавить внешние факторы (например, ключевую ставку, налоговые дни, макроэкономику).
- В условиях банковской ликвидности такие переменные могут заметно улучшить качество прогноза, поэтому в финальной версии лучше использовать именно SARIMAX.


# Выбор параметров

Основываясь на результатах анализа:

| Параметр | Значение | Пояснение |
|:--------:|:--------:|:----------|
| `d` | 1 | Необходимость обычного дифференцирования |
| `D` | 1 | Требуется сезонное дифференцирование с периодом 7 |
| `s` | 7 | Сезонный период — неделя |
| `p` | 1 или 2 | PACF показывает пики на лагах 1–2 |
| `q` | 0 или 1 | ACF быстро обрубается на лаге 1 |
| `P` | 1 | Сильная сезонная авторегрессия на лаге 7 |
| `Q` | 0 или 1 | Возможен сезонный MA-компонент |

Таким образом, для старта можно взять:
- `(p=1..2, d=1, q=0..1)` и `(P=1, D=1, Q=0..1, s=7)`


# **Блок 3. Построение авторегрессионных моделей**   <a class="anchor" id="3"></a>

## Выводы по автогрегрессионным моделям:

На первом этапе были обучены и проанализированы базовые авторегрессионные модели для прогнозирования баланса ликвидности на следующий день.

Данные были разделены на обучающую и тестовую выборки:
- **Train**: 1382 наблюдения,
- **Test**: 154 наблюдения.

## SARIMA (1,1,1)x(1,1,1,7)

- Базовая модель SARIMA без использования внешних факторов показала **MAE = 0.2309**.
- Добавленная маржа по прогнозу практически нулевая (**-0.0000013 руб/день**), нормированная добавленная маржа — **-0.00056%** от среднего баланса.
- График прогнозов показывает, что SARIMA достаточно точно следует за фактическими данными, особенно в спокойные периоды, и демонстрирует стабильное поведение без резких отклонений.
- Таким образом, базовая SARIMA хорошо справляется с задачей минимизации ошибки прогноза, но не приносит заметной выгоды в части увеличения доходности.

## SARIMAX с внешними признаками (top-20 по Mutual Information)

- SARIMAX, обученная на 20 наиболее информативных признаках по Mutual Information, показала **более высокую ошибку** — **MAE = 0.2715**.
- При этом прогноз модели оказался **более волатильным**: в периоды резких изменений баланса ошибка увеличивается.
- Однако добавленная маржа оказалась **положительной** (**+0.00000093 руб/день**, нормированная маржа +0.00039% от среднего баланса).
- Это означает, что несмотря на ухудшение точности прогноза, **SARIMAX более выгодна с точки зрения бизнес-результата**: модель помогает чаще принимать решения, увеличивающие доходность операций с ликвидностью.

## Визуальный анализ

- На графике видно, что SARIMA ближе следует за фактическими данными, тогда как SARIMAX иногда уходит выше или ниже реальных значений, особенно в моменты нестабильности.
- Тем не менее, SARIMAX захватывает больше движений рынка, что при правильной настройке модели и контроле рисков может быть полезнее для максимизации прибыли.


### Общий итог

- **Базовая SARIMA** лучше всего подходит для задачи минимизации ошибки прогноза.
- **SARIMAX с отобранными признаками** имеет потенциал для увеличения прибыли, несмотря на чуть большую погрешность в прогнозах.


# **Блок 4. tsfresh как обогащение признаков**  <a class="anchor" id="4"></a>

#  **Блок 5. Отбор признаков (FS) для ML**  <a class="anchor" id="5"></a>



## Выводы по сравнению разных методов Feature Selection

Для выбора базового метода отбора признаков в проекте я сравнил несколько подходов из разных категорий: фильтрационные (Mutual Information), встроенные (Embedded методы) и оберточные (WrapperRFE).

Результаты тестирования с использованием скользящей проверки по времени (TimeSeriesSplit) показали следующую картину:

**Выводы:**

1. **Фильтрационные методы** (Mutual Information) быстро работают и устойчивы, но плохо учитывают взаимодействия между признаками. Это сказывается на качестве модели: в среднем оно ощутимо ниже, чем у встроенных методов.

2. **Оберточные методы** (WrapperRFE) лучше захватывают сложные зависимости между признаками и таргетом, но цена за это — высокая вычислительная нагрузка. Для пайплайна с регулярным автообучением это не самое разумное решение, особенно если учесть, что прирост качества по сравнению с Embedded отсутствует.

3. **Embedded методы** оказались наиболее сбалансированными: они автоматически учитывают взаимодействия между признаками, при этом не требуют настолько больших ресурсов, как обертки. Встроенный отбор признаков опирается на важности, вычисляемые во время обучения модели, что обеспечивает естественную устойчивость к переобучению и хорошую адаптацию к изменениям данных.

**Почему для дальнейших моделей выбран Embedded метод:**

- Он показал **самое высокое среднее качество** среди всех протестированных методов.
- Он более **вычислительно эффективен** по сравнению с оберточными подходами, что критично для автоматизированного переобучения модели без ручного контроля.
- Встроенный отбор в модели (такие как LGBM и прочие) умеет **естественно учитывать нелинейные зависимости** между признаками и целевой переменной, что было дополнительным требованием в проекте.
- Метод обеспечивает **хороший баланс между стабильностью и точностью**, что особенно важно для банковского бизнес-процесса, где прогнозы ложатся в основу решений о перераспределении ликвидности.

Таким образом, в качестве базового способа отбора признаков для итоговой модели выбран именно **Embedded метод**.


# **Блок 6. Построение ML моделей**  <a class="anchor" id="6"></a>



## Описание реализованного модуля обучения

Далее представлен модуль `ModelPipeline`, реализующий автоматизированное обучение моделей машинного обучения для прогнозирования значения сальдо банковской ликвидности.

### Функциональность модуля

Модуль позволяет:

* Автоматически подбирать гиперпараметры моделей с использованием библиотеки Optuna;
* Выполнять отбор признаков на основе важности, вычисленной для каждой модели;
* Обучать и переобучать модели в соответствии с заданной датой начала тестирования;
* Оценивать точность предсказания по кастомной метрике, зависящей от ключевой ставки и бизнес-показателей;
* Использовать дополнительные метрики, отражающие прибыльность и стабильность прогнозов;
* Визуализировать прогноз по сравнению с реальными значениями.

### Обоснование выбора метода калибровки

Одной из особенностей реализации является использование библиотеки Optuna для автоматической калибровки гиперпараметров. Это решение обосновано следующими преимуществами:

* Поддержка байесовского подхода к оптимизации (алгоритм TPE), который позволяет быстрее находить оптимальные параметры в условиях ограниченного числа итераций;
* Гибкость в определении пространства гиперпараметров — используется функциональный стиль задания диапазонов, что позволяет легко адаптировать параметры под любую модель;
* Возможность напрямую использовать пользовательскую метрику, учитывающую внешние экономические факторы, например ключевую ставку;
* Удобная визуализация хода оптимизации и прозрачность процесса подбора параметров;
* Поддержка случайного сида, обеспечивающая воспроизводимость.

Таким образом, использование Optuna позволяет совместить высокую эффективность поиска параметров с удобной интеграцией в производственный пайплайн.

### Связь с бизнес-метрикой

В соответствии с требованиями бизнес-заказчика, целевая метрика (`metric_func`) может быть выбрана так чтобы она учитывала влияние ошибки прогноза на возможную прибыль. Функция может принимать в расчёт не только прогноз и фактическое значение сальдо, но и ключевую ставку, что позволит оценивать потери при ошибочном размещении или привлечении средств. Это позволит оптимизировать модель с учётом реальной стоимости ошибки и приблизить модель к задачам бизнес-принятия решений.

Также предусмотрена возможность передачи дополнительных метрик (например, `calculate_add_margin_vectorized`, `delta_pnl`), что позволяет рассчитывать альтернативные показатели эффективности и сравнивать поведение моделей в разных сценариях.

### Причины выбора временной кросс-валидации

Для оценки модели используется `TimeSeriesSplit`, что обосновано спецификой задачи. Временные ряды требуют соблюдения хронологии при обучении и валидации, поэтому традиционные методы кросс-валидации неприемлемы из-за утечки информации из будущего в прошлое. Использование временного разбиения позволяет адекватно оценить модель на имитированных будущих данных и снизить переобучение.

### Принципы отбора признаков

После завершения подбора гиперпараметров модель обучается повторно, и на её основе производится отбор наиболее важных признаков. Для моделей, поддерживающих `feature_importances_` (например, RandomForest и LightGBM), либо `coef_` (например, Ridge), вычисляется список наиболее значимых переменных. Выбираются top-k признаков, которые затем используются для финального прогноза. Это не только снижает переобучение и ускоряет вычисления, но и делает модель более устойчивой к шуму в данных.

### Гибкость и расширяемость

Модуль реализован как гибкая структура с параметрами, задаваемыми при инициализации. В частности:

* Словарь моделей `models_config` позволяет легко добавлять новые алгоритмы без переписывания кода.
* Количество фолдов, число признаков и число итераций задаются вручную в момент инициализации.
* Поддерживается возможность как обучения с калибровкой параметров, так и запуска модели с параметрами по умолчанию.

Благодаря такой архитектуре модуль может быть использован в разных сценариях — как в режиме быстрой отладки, так и в полномасштабном поиске оптимальных решений.

### Визуализация и проверка качества

Модуль содержит встроенный механизм визуализации результатов прогноза. Сравнение графиков предсказанных и фактических значений позволяет визуально контролировать наличие систематических ошибок, отставаний и резких отклонений, а также служит основой для ручной валидации модели в случае разладки.




### Выводы по результатам моделей

По итогам тестирования моделей прогнозирования сальдо были получены следующие результаты:

- **RandomForest** показал наименьшую ошибку MAE (**0.171**) среди всех моделей. Однако его значение метрики `delta_pnl` оказалось самым высоким по модулю (**–0.378**), что свидетельствует о потенциально большем отрицательном влиянии на итоговый финансовый результат в случае ошибок прогноза.
- **CatBoost** продемонстрировал MAE чуть выше (**0.183**), при этом его `delta_pnl` составил **–0.300**, что лучше, чем у RandomForest. Однако общий уровень ошибки остаётся выше, а финансовый эффект (normalized_add_margin) не даёт явных преимуществ.
- **LGBM** показал MAE на уровне **0.185**, то есть несколько выше, чем у RandomForest и CatBoost. При этом у него лучший результат по нормализованной бизнес-метрике: значение `normalized_add_margin` положительное (**0.000332**), что означает потенциальный прирост маржи, а не её потерю. Хотя `delta_pnl` составляет **–0.423**, это значение необходимо интерпретировать осторожно в контексте основной метрики — прибыльности и стабильности модели.

### Обоснование выбора LGBM

Несмотря на то, что LGBM показал чуть более высокую абсолютную ошибку MAE по сравнению с другими моделями, его выбор оправдан по следующим причинам:

1. **Бизнес-ориентированная метрика важнее простой точности:**
   Основная задача модели — не просто минимизировать MAE, а способствовать увеличению маржи при принятии решений по управлению ликвидностью. LGBM — дала наибольшее значение `normalized_add_margin`, что свидетельствует о наилучшей способности увеличивать доходность.

2. **Баланс между ошибкой прогноза и финансовым эффектом:**
   LGBM обеспечивает приемлемый уровень ошибки  и при этом минимизирует риски упущенной прибыли за счёт положительного вклада в маржу. Для целей проекта такой баланс между точностью и финансовой выгодой важнее минимальной ошибки MAE сама по себе.

3. **Гибкость и скорость обучения:**
   LGBM обладает высокой скоростью обучения и возможностями для эффективного тюнинга гиперпараметров, что важно в рамках автоматизированного пайплайна с периодическим дообучением модели. Это упрощает интеграцию модели в рабочий процесс.

4. **Стабильность на временных рядах:**
   По опыту применения LGBM в задачах прогнозирования временных рядов модель хорошо справляется с сложными нелинейными зависимостями и устойчива к небольшим изменениям распределения данных, что критично в условиях нестабильности финансовых потоков.


## Теперь обучим модель LGBM на датасете `tsfresh`


### **Выводы о целесообразности использования `tsfresh`-признаков**

**Метрики качества предсказаний:**

| Показатель                         | Без `tsfresh` | С `tsfresh` |
| ---------------------------------- | ------------- | ----------- |
| MAE                                | **0.1857**    | 0.2248      |
| calculate\_add\_margin\_vectorized | 5.6e-07       | **4.0e-06** |
| normalized\_add\_margin            | 0.00019       | **0.00138** |
| delta\_pnl                         | **-0.4239**   | -0.2400     |

**Анализ графиков:**

* На **первом графике** (без `tsfresh`) наблюдается более чуткое следование модели за фактическими колебаниями сальдо, особенно в периоды с резкими провалами. Модель лучше распознаёт экстремальные значения, но, возможно, переобучается на локальные шумы.
* На **втором графике** (с `tsfresh`) прогноз выглядит **сглаженным и менее чувствительным к выбросам**. Это говорит о том, что модель может быть устойчивее к шуму, но хуже захватывает пики и просадки — особенно это видно на глубоком падении в конце 2020 года.

**Интерпретация:**

* Несмотря на ухудшение MAE, признаки `tsfresh` способствуют генерации прогнозов с **меньшими отклонениями в отрицательную сторону** и потенциально **меньшими убытками**, что подтверждается улучшением `delta_pnl`.
* Визуально модель с `tsfresh` может **быть предпочтительнее для стратегий, ориентированных на снижение риска и избегание резких потерь**, но может упускать экстремальные положительные сценарии.

**Выводы:**

* Использование `tsfresh`- признаков оправдано, если приоритетом является **устойчивость модели и управление рисками**.
* В задачах, где критично **точно прогнозировать экстремумы**, лучше использовать базовый набор признаков.


# **Блок 7. Обнаружение разладок (CUSUM)**   <a class="anchor" id="7"></a>


### Обоснование выбора метода детекции разладок

Для задачи обнаружения разладок в прогнозировании сальдо потоков ликвидности банка был выбран метод на основе универсального CUSUM-детектора с возможностью работы в двух режимах: **гибридном** (классический CUSUM) и **адаптивном** (адаптивный CUSUM с обновлением оценки среднего и дисперсии).

**Причины выбора именно такого метода:**

1. **Высокая чувствительность к небольшим изменениям распределения:**
   Бизнес-процесс требует своевременного обнаружения изменений в динамике потоков ликвидности, так как промедление может привести к финансовым потерям. Классический CUSUM хорошо выявляет сдвиги среднего значения, а адаптивная версия дополнительно учитывает изменение дисперсии и динамики процесса, что особенно важно в условиях финансовых временных рядов, где волатильность может существенно изменяться.

2. **Низкие вычислительные затраты и возможность онлайн-обновления:**
   Реализованная версия `UniversalCUSUMDetector` поддерживает как пакетную обработку (`detect`), так и пошаговое обновление на новых данных (`update`). Это позволяет легко встроить детектор в автоматизированный пайплайн, где модель прогнозирования будет ежедневно получать новые данные и должна без задержек фиксировать возможные аномалии в потоке.

3. **Гибкость под специфику банка:**
   Режим `adaptive` позволяет подстраиваться под медленные изменения распределения данных, что характерно для банковских процессов в периоды без сильных внешних шоков. Режим `hybrid` позволяет быстро реагировать на резкие внешние события (например, крупные налоговые платежи, изменение ключевой ставки). Это важно, поскольку поведение потоков ликвидности может резко меняться в зависимости от внешних макроэкономических факторов, налогового календаря и других причин.

4. **Контроль частоты ложных срабатываний:**
   Параметр `min_distance` позволяет отфильтровать слишком частые сигналы, что снижает вероятность перехода на ручное управление без объективной необходимости. Это особенно важно для минимизации нагрузки на операторов, так как лишние сигналы могли бы приводить к ненужным вмешательствам в процесс.

5. **Настраиваемые параметры под специфику бизнеса:**
   Использование настраиваемых порогов (`threshold`), дрейфа (`drift`) и параметров адаптации (`alpha`, `beta`, `mean_diff`) позволяет отдельно подобрать конфигурацию детектора для разных особенностей ряда (например, сальдо может требовать одной чувствительности, а притоки и оттоки — другой).


### Обоснование структуры реализации

1. **Поддержка двух режимов работы (`adaptive`, `hybrid`):**
   Это решение позволяет выбирать стратегию обнаружения разладок в зависимости от характера текущих данных. Например, если известно, что сейчас идут налоговые выплаты — можно работать в `hybrid`-режиме для жёсткого отслеживания отклонений.

2. **Плавное обновление оценок среднего и дисперсии в адаптивном режиме:**
   В адаптивном режиме реализовано экспоненциальное сглаживание оценок (`alpha`, `beta`), что делает детектор устойчивым к шуму и позволяет учитывать только значимые тренды в изменении данных.

3. **Онлайн-обновление состояния (`update`):**
   Для построения промышленного пайплайна важно, чтобы разладки можно было фиксировать без необходимости переобработки всего временного ряда, а только на основании новых данных, что и реализовано в методе `update`.

4. **Фильтрация близких по времени событий:**
   Для предотвращения избыточных сигналов используется фильтрация по минимальной дистанции между разладками (`min_distance`). Это практическое решение позволяет оставить только наиболее важные события и избежать ложной тревоги.

5. **Визуализация результатов:**
   Встроенный пример использования сразу показывает на графиках найденные точки разладки, что позволяет легко и быстро провести валидацию корректности работы детектора на реальных данных.

### Почему метод хорошо подходит под специфику задачи

- В условиях банковской ликвидности важно быстро фиксировать **как резкие всплески**, так и **плавные изменения** поведения процессов. Реализация двух режимов позволяет это сделать.
- Поскольку автоматизация требует полной самостоятельности работы моделей без ручного вмешательства, выбранный детектор соответствует требованию непрерывного мониторинга без необходимости перезапуска или пересчёта всего ряда.
- Способность детектора быть **адаптивным** к текущим условиям рынка соответствует реальности финансовых процессов, где распределения редко бывают стационарными.
- Возможность конфигурировать пороги позволяет дополнительно откалибровать чувствительность разладки под бизнес-метрику, минимизируя число ложных переходов на ручное управление.


### Выводы по поведению детектора

- **Hybrid режим** находит много точек разладки, включая небольшие отклонения даже при незначительных колебаниях ряда.
- **Adaptive режим** реагирует только на более крупные и устойчивые изменения поведения данных.


### Преимущества и недостатки каждого режима

**Hybrid режим:**

Преимущества:
- Очень высокая чувствительность к сдвигам среднего значения.
- Позволяет оперативно отлавливать локальные скачки или провалы в данных, которые могут быть связаны с важными для ликвидности банка событиями.
- Хорошо работает в условиях, когда изменения происходят резко и имеют короткий характер.

Недостатки:
- Генерирует большое количество срабатываний, включая шумовые сигналы.
- Требует более внимательной фильтрации и настройки параметров (например, `threshold`, `min_distance`), чтобы избежать перегрузки процессом ручного управления.
- Может приводить к избыточному числу внеплановых переключений на ручной режим, что увеличит нагрузку на операторов.

**Adaptive режим:**

Преимущества:
- Выявляет только действительно значимые изменения, фильтруя краткосрочный шум.
- Обеспечивает более стабильную работу пайплайна без излишних переключений на ручное вмешательство.
- Лучше подходит для процессов с относительно плавной динамикой изменений, характерных для типичного банковского потока ликвидности вне кризисных ситуаций.

Недостатки:
- Менее чувствителен к коротким и резким аномалиям. При резком внешнем шоке (например, неожиданном изменении макроэкономических условий) может среагировать с запозданием.
- Требует аккуратной калибровки параметров адаптации (`alpha`, `beta`) под разные стадии рыночного цикла.

### Сценарии применения

- В обычные стабильные периоды, когда в потоках ликвидности отсутствуют резкие изменения, целесообразно применять **адаптивный режим**. Он позволяет избегать ложных срабатываний и обеспечивает более надёжную работу системы без лишних переключений на ручное управление.

- В случае наступления кризисных или высоковолатильных периодов на рынке имеет смысл заранее планировать переход на **гибридный режим** для более плотного контроля за процессами.

Таким образом, выбор режима должен быть увязан с бизнес-контекстом: адаптивный режим — для спокойных условий, гибридный — для периодов повышенного риска и нестабильности.


# **Блок 8. Онлайн запуск и автоматическое переобучение**  <a class="anchor" id="8"></a>

## Добавление режима онлайн-прогноза в код ModelPipeline

В обновлённой версии модуля обучения был реализован режим онлайн-прогноза, оформленный в виде класса `ModelPipelineOnline`. Это расширение направлено на приближение модели к реальным условиям эксплуатации, где требуется ежедневно выдавать прогноз с возможностью автоматического реагирования на изменение структуры данных.

Бизнес-процесс принятия решений по управлению ликвидностью требует ежедневного прогноза сальдо. При этом критически важно:

* своевременно выявлять **структурные сдвиги** или **разладки** в модели,
* выполнять переобучение только при необходимости (в целях экономии ресурсов),
* поддерживать **высокую адаптивность** и **устойчивость** модели в онлайн-режиме.

Реализация онлайн-режима позволила обеспечить автоматическую ежедневную работу прогностической системы без участия человека, с возможностью автономного переобучения и мониторинга качества.


## Принцип работы онлайн-режима

Функциональность онлайн-прогноза реализована в методе `online_run`. Работа модуля строится следующим образом:

1. **Первичное обучение до даты начала онлайн-прогноза (`start_date`)**.
   Модель калибруется на исторических данных с использованием Optuna.

2. **День за днём** происходит:

   * Получение одного нового наблюдения;
   * Предсказание сальдо на этот день;
   * Вычисление набора метрик: как стандартных (MAE), так и бизнес-ориентированных (`delta_pnl`, `normalized_add_margin`, и др.);
   * Обновление графика ошибок.

3. **Выявление разладки через адаптивный алгоритм CUSUM**:
   Используется класс `UniversalCUSUMDetector`, позволяющий отслеживать накопленную ошибку модели и реагировать при превышении порога. В случае срабатывания:

   * модель автоматически переобучается на всех доступных данных до текущего дня;
   * при этом можно задать параметры чувствительности, минимальное расстояние между разладками и метод адаптации.

4. **Регулярное переобучение по расписанию**:

   * Каждые `n` воскресений выполняется переобучение **без калибровки** параметров — для адаптации к текущему состоянию данных;
   * Каждые `m` воскресений выполняется полное переобучение **с калибровкой** через Optuna;
   * Это позволяет сбалансировать между стабильностью и актуальностью модели без избыточных затрат на вычисления.

5. **Анализ результатов и визуализация**:

   * Для каждой даты сохраняются значения метрик и прогнозов;
   * Визуализируется сравнение прогноза и факта, с отображением точек разладки;
   * Выводятся средние значения метрик за весь период.


## Гибкость и адаптируемость

Параметры онлайн-режима вынесены наружу и настраиваются через аргументы `online_run`:

* дата начала (`start_date`);
* параметры чувствительности и типа режима для CUSUM;
* частота регулярного переобучения (`retrain_every_n_sundays`);
* частота полной перекалибровки (`reoptimize_every_m_sundays`);
* выбор модели (`model_name`);
* список дополнительных метрик.

Это обеспечивает простоту экспериментов и точную подстройку.


### **Выводы по результатам онлайн-прогноза**

1. **Модель обеспечивает высокую точность прогнозирования сальдо**
   В процессе ежедневного онлайн-прогноза модель стабильно достигает низких значений ошибки MAE. Это особенно важно, учитывая, что сами значения целевой переменной (`balance`) находятся в диапазоне порядка десятых долей, и даже небольшие отклонения могут существенно влиять на решения по управлению ликвидностью.

2. **Показатели бизнес-метрики `add_margin` соответствуют масштабу задачи**
   Хотя абсолютные значения `calculate_add_margin_vectorized` малы, это объясняется самим масштабом денежных потоков в исходных данных. На фоне типичных величин сальдо порядка ±0.1–0.4 даже незначительное улучшение прогноза может приносить ощутимую экономическую выгоду. В отдельных днях наблюдаются стабильные положительные значения `normalized_add_margin`, что говорит о способности модели повышать маржу при верных сигналах.

3. **Механизм автоматической адаптации работает надёжно**
   Модель переобучается по расписанию (в выходные) и при обнаружении разладки, что позволяет ей гибко адаптироваться к изменениям во временном ряду. Детектор CUSUM эффективно фиксирует эпизоды ухудшения качества прогноза и запускает внеплановое переобучение.

4. **Оптимизация гиперпараметров способствует снижению ошибок и потерь**
   Калибровка модели с помощью Optuna позволяет на регулярной основе подбирать более эффективные параметры. Это помогает не только снизить ошибку прогнозирования, но и минимизировать потенциальные потери, измеряемые через `delta_pnl`.

5. **Бизнес-метрики усиливают интерпретируемость модели**
   Использование `normalized_add_margin` и `delta_pnl` в дополнение к стандартным метрикам (MAE) позволяет судить о практической пользе модели в управлении ликвидностью. Отслеживание этих метрик показало, что модель не склонна к агрессивным переоценкам, избегая убытков при неправильном прогнозе.

6. **Система онлайн-прогноза устойчиво работает в автоматическом режиме**
   Все этапы — от прогнозирования до оценки качества и автоматического реагирования на разладку — выполняются без вмешательства пользователя. Это соответствует требованию полной автоматизации пайплайна и обеспечивает надёжность в долгосрочной перспективе.




### **Анализ влияния изменения метрики калибровки на результаты онлайн-прогноза**

В данном этапе эксперимента была проведена модификация параметров обучения модели:

* **Целевая метрика калибровки в Optuna** была изменена с `mean_absolute_error` на **кастомную бизнес-метрику** `calculate_add_margin_vectorized`, измеряющую дополнительную маржу от размещения средств.
* Направление оптимизации было переключено с `"minimize"` на `"maximize"`, что соответствует бизнес-интересу — максимизировать потенциальную прибыль от точного прогноза сальдо.





### **Анализ влияния изменения параметров калибровки на онлайн-прогноз**

В этом этапе пайплайна была изменена логика подбора гиперпараметров модели:

* Вместо стандартной ошибки `MAE` в качестве целевой метрики Optuna применялась **бизнес-метрика** `calculate_add_margin_vectorized`, отражающая дополнительную маржу от точного прогноза.
* Направление оптимизации было изменено на `"maximize"`, чтобы ориентироваться не на точность как таковую, а на максимизацию финансовой выгоды.

### **Сравнение итогов: до и после изменения метрики**

| Метрика                 | Было (MAE-калибровка) | Стало (add\_margin-калибровка) |
| ----------------------- | --------------------- | ------------------------------ |
| `MAE`                   | 0.1813                | **0.2302**                     |
| `add_margin`            | 1e-6                  | **2e-6**                       |
| `normalized_add_margin` | 0.0873                | **6.7013**                     |
| `delta_pnl`             | -0.6234               | **-0.6221**                    |

### **Выводы**

1. **Рост бизнес-выгоды при умеренном снижении точности**:

   Средняя **дополнительная маржа** увеличилась в 2 раза — с 1e-6 до 2e-6, а **нормализованная маржа увеличилась** — с 0.087 до 6.7 от среднего сальдо. Это означает, что при новом подходе модель **гораздо чаще и точнее захватывает прибыльные возможности**. При этом средний `MAE` вырос всего на \~0.05, что является допустимой платой за столь существенный рост выгоды.

2. Визуальный анализ прогноза (см. графики выше)

* **До изменения метрики**: модель следует за общим трендом, но часто сглаживает резкие изменения, с некоторым недопредсказанием пиков и провалов.
* **После оптимизации на бизнес-метрику**: прогнозы стали **более амплитудными**, часто выходя выше истинных значений. Это связано с тем, что маржа нарастает только при положительном прогнозе и хорошей оценке избыточной ликвидности — модель теперь стремится «брать на себя риск» в этих точках. Разладки фиксируются чаще, что позволяет **адаптировать модель к новым структурам отклонений**.

3. **Снижение потерь `delta_pnl` практически не наблюдается, но они не ухудшились:**

   Несмотря на агрессивную калибровку на маржу, `delta_pnl` **остался почти неизменным** (−0.62), что говорит о **сбалансированной стратегии**: модель стала приносить больше дохода, не увеличив сопутствующие потери.


4. **Вывод:**

Изменение калибровочной метрики позволило:

* **Повысить добавленную маржу** — ключевой целевой показатель бизнес-заказчика.
* **Сохранять контроль над убытками** (`delta_pnl`) при разумном ухудшении MAE.
* **Сделать модель более агрессивной в предсказании положительного сальдо**, что оправдано с точки зрения стратегии увеличения доходности.

   Учитывая, что цель проекта — именно **максимизация доходности от решений позиционера**, переход на `calculate_add_margin_vectorized` как основную метрику калибровки оправдан, так как это **прямо улучшает бизнес-результат**.



### Сравнение результатов модели при разных наборах признаков

Были протестированы три конфигурации:

| Набор признаков                      | MAE       | `calculate_add_margin_vectorized` | `normalized_add_margin` | `delta_pnl` |
| ------------------------------------ | --------- | --------------------------------- | ----------------------- | ----------- |
| **Базовые фичи, MAE-оптимизация**    | **0.181** | 0.000001                          | 0.087                   | -0.623      |
| **Базовые фичи, бизнес-оптимизация** | 0.230     | **0.000002**                      | 6.701                   | **-0.622**  |
| **`tsfresh`, бизнес-оптимизация**    | 0.199     | 0.000001                          | **16.410**              | -0.647      |

#### Выводы:

* **Ключевая метрика `calculate_add_margin_vectorized` достигла максимума при базовых признаках с оптимизацией под маржу** — 0.000002. Однако при использовании признаков `tsfresh` значение вернулось к 0.000001, несмотря на заметный рост `normalized_add_margin`.

* **Несоответствие между `calculate_add_margin_vectorized` и `normalized_add_margin` объясняется нормализующим делителем**, который в `normalized_add_margin` равен среднему положительному значению баланса (`balance_reference`). При признаках `tsfresh` в периоде были дни с очень малым или близким к нулю положительным сальдо, что приводит к **раздуванию относительной метрики** (`normalized_add_margin`), даже если абсолютная маржа осталась прежней.

* При этом **ошибка MAE улучшилась** по сравнению с бизнес-оптимизацией на базовых фичах (0.230 → 0.199), что указывает на лучшее приближение модели к реальному значению сальдо.

* Графически (см. рисунок) видно, что при использовании `tsfresh`-фичей модель **более гибко реагирует на изменения**, особенно вблизи резких просадок или всплесков. Прогнозы визуально лучше следуют за структурой ряда.

#### Заключение:

* Если приоритет — **максимизация абсолютной добавленной маржи**, то на текущем периоде выигрывают базовые признаки с оптимизацией под `calculate_add_margin_vectorized`.
* Однако **`tsfresh`-фичи обеспечивают большую относительную прибыльность (`normalized_add_margin`) при сопоставимой MAE**, что делает их особенно привлекательными в условиях, где позитивные балансы невелики и важна чувствительность модели к слабым движениям.

Таким образом, **выбор между базовыми признаками и `tsfresh` зависит от приоритета: стабильная абсолютная маржа или высокая чувствительность к доходным отклонениям при малом балансе.**



# Итоговый вывод по проекту <a class="anchor" id="9"></a>

В ходе проекта был реализован полностью автоматизированный пайплайн прогнозирования банковского сальдо, соответствующий всем ключевым требованиям бизнес-заказчика:

* Модель ежедневно предсказывает значения сальдо с точностью, достаточной для принятия решений по управлению ликвидностью.
* Оптимизация по кастомной бизнес-метрике `calculate_add_margin_vectorized` позволила **значимо увеличить потенциальную маржу**, при допустимом ухудшении MAE.
* Внедрён **адаптивный детектор разладок (CUSUM)**, который надёжно отслеживает ухудшения качества и инициирует автоматическое переобучение модели без вмешательства человека.
* Проведено сравнение различных конфигураций: базовые признаки против `tsfresh`, MAE против бизнес-метрик, SARIMA против ML-моделей. Это позволило выбрать **наиболее выгодный компромисс между стабильностью, точностью и финансовым эффектом**.
* Итоговая модель (LGBM с оптимизацией на маржу) демонстрирует **устойчивую работу в онлайн-режиме**, сочетая разумный уровень ошибки, положительную нормализованную маржу и контроль потерь (`delta_pnl`).
* Модель легко масштабируема, параметризуема и может быть адаптирована к другим временным рядам или внешним условиям.

Таким образом, **цель проекта — автоматизация прогнозирования сальдо с учётом бизнес-выгоды — достигнута**. Разработанная система повышает доходность операций банка, минимизирует риски и работает в фоновом режиме, не требуя постоянного участия аналитика.

